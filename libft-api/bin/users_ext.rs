use std::{io::Write, sync::Arc, time::Duration};

use libft_api::prelude::*;
use serde_with::DurationSeconds;
use tokio::{task::JoinSet, time::sleep};

#[tokio::main]
async fn main() {
    tracing_subscriber::fmt::init();
    let mut handles = JoinSet::new();
    let user_ids = [
        249693, 249676, 247198, 247197, 247155, 247154, 247153, 247152, 247151, 247150, 247149,
        247148, 247147, 247146, 247145, 247144, 247143, 247142, 247141, 247140, 247139, 247138,
        247137, 247136, 247135, 247134, 247133, 247132, 247131, 247130, 247129, 247128, 247127,
        247126, 247125, 247124, 247123, 247122, 247121, 247120, 247119, 247118, 247117, 247116,
        247115, 247114, 247113, 233656, 233630, 233629, 233628, 233627, 233626, 233625, 233624,
        233623, 233622, 233621, 233620, 233619, 233618, 233617, 233616, 233615, 233614, 233613,
        233612, 233611, 233610, 233609, 233608, 233607, 233606, 233605, 233604, 233603, 233602,
        233601, 233600, 233599, 233598, 233597, 233596, 233595, 233594, 233593, 233592, 233591,
        233590, 233589, 233588, 233587, 233586, 233585, 233584, 233583, 233582, 233581, 233580,
        233579, 179841, 179840, 179839, 179838, 179837, 179836, 179835, 179834, 179833, 179832,
        179831, 179830, 179829, 179828, 179827, 179826, 179825, 179824, 179823, 179822, 179821,
        179820, 179819, 179818, 179817, 179816, 179815, 179814, 179813, 179812, 179811, 179810,
        179809, 179808, 179807, 179806, 179805, 179804, 179803, 179802, 179801, 179800, 179799,
        179798, 179797, 179796, 179795, 179794, 179793, 179792, 179791, 179790, 179789, 179788,
        179787, 179786, 179785, 179784, 179783, 179782, 179781, 179780, 179779, 179778, 179777,
        179776, 179775, 179774, 179773, 179772, 179771, 179770, 179769, 179768, 179767, 179766,
        179765, 179764, 179763, 179762, 179761, 179760, 179759, 179758, 179757, 179756, 179755,
        179754, 179753, 179752, 179751, 179750, 179749, 179748, 179747, 179746, 179745, 179744,
        179743, 179742, 197399, 197398, 197397, 197396, 197395, 190940, 190937, 190935, 190929,
        190928, 190926, 190925, 190924, 190923, 190922, 190921, 190920, 190918, 190916, 190915,
        190913, 190912, 190911, 190910, 190909, 190908, 190907, 190906, 190905, 190903, 190902,
        190901, 190900, 190899, 190898, 190897, 190896, 190895, 190894, 190893, 190892, 190891,
        190890, 190889, 190888, 190887, 190886, 190885, 190884, 190883, 190882, 190881, 190880,
        190879, 190878, 190877, 190876, 190875, 190874, 190873, 190872, 190871, 190870, 190869,
        190868, 190867, 190866, 190865, 190864, 190863, 190862, 190861, 190860, 190859, 190858,
        190857, 190856, 190855, 190854, 190853, 190852, 190851, 190850, 190849, 190848, 190847,
        190846, 190845, 190844, 190843, 190842, 190841, 190840, 190839, 190838, 190837, 190836,
        190835, 190834, 190833, 197499, 197498, 197497, 197496, 197495, 197494, 197493, 197492,
        197491, 197490, 197489, 197488, 197487, 197486, 197485, 197484, 197483, 197482, 197481,
        197480, 197479, 197478, 197477, 197476, 197475, 197474, 197473, 197472, 197471, 197470,
        197469, 197468, 197467, 197466, 197465, 197464, 197463, 197462, 197461, 197460, 197459,
        197458, 197457, 197456, 197455, 197454, 197453, 197452, 197451, 197450, 197449, 197448,
        197447, 197446, 197445, 197444, 197443, 197442, 197441, 197440, 197439, 197438, 197437,
        197436, 197435, 197434, 197433, 197432, 197431, 197430, 197429, 197428, 197427, 197426,
        197425, 197424, 197423, 197422, 197421, 197420, 197419, 197418, 197417, 197416, 197415,
        197414, 197413, 197412, 197411, 197410, 197409, 197408, 197407, 197406, 197405, 197404,
        197403, 197402, 197401, 197400, 172332, 172331, 172330, 172329, 172327, 172326, 172325,
        172324, 172323, 172322, 172321, 172320, 172319, 172318, 172317, 172316, 172315, 172314,
        172313, 172312, 172311, 172310, 172309, 172308, 172307, 172306, 172305, 172304, 172303,
        172300, 172291, 172278, 171847, 171431, 171430, 171427, 170268, 166798, 166797, 166796,
        166795, 166794, 166793, 166792, 166791, 159380, 151095, 84509, 233578, 233577, 233576,
        233575, 233574, 233573, 233572, 233571, 233570, 233569, 233568, 233567, 233566, 233565,
        233564, 233563, 233562, 233561, 233560, 233559, 233558, 233557, 233556, 233555, 233554,
        233553, 233552, 233551, 233550, 233549, 233548, 233547, 233546, 233545, 233544, 233543,
        233542, 233541, 233540, 233539, 233538, 233537, 233536, 233535, 233534, 233533, 233532,
        233531, 233530, 233529, 233528, 233527, 233526, 233525, 233524, 233523, 233522, 233521,
        233520, 233519, 233518, 233517, 233516, 233515, 233514, 233513, 233512, 233511, 233510,
        233509, 233508, 233507, 233506, 233505, 233504, 233503, 233502, 233501, 233500, 233499,
        233498, 233497, 233496, 233495, 233494, 233493, 233492, 233491, 233490, 233489, 233488,
        233487, 233486, 233485, 233484, 233483, 233482, 233481, 233480, 233479, 179741, 179740,
        179739, 179738, 179737, 179736, 179735, 179734, 179733, 179732, 179731, 179730, 179729,
        179728, 179727, 179726, 179725, 179724, 179723, 179722, 179721, 179720, 179719, 179718,
        179717, 179716, 179715, 179714, 179713, 179712, 179711, 179710, 179709, 179708, 179707,
        179706, 179705, 179704, 179703, 179702, 179701, 179700, 179699, 179698, 179697, 179696,
        179695, 179694, 179693, 179692, 179691, 179690, 179689, 179688, 179687, 179686, 179685,
        179684, 179683, 179682, 179681, 179680, 179679, 179678, 179677, 179676, 179675, 179674,
        179673, 179672, 179671, 179670, 179669, 179668, 179667, 179666, 179665, 179664, 179663,
        179662, 179661, 179660, 179659, 179658, 179657, 179656, 179655, 179654, 179653, 179652,
        179651, 179650, 179649, 179648, 179647, 179646, 179645, 179644, 179643, 179642, 207162,
        207161, 207160, 207159, 207158, 207157, 207156, 207155, 207154, 207153, 207152, 207151,
        207150, 207149, 207148, 207147, 207146, 207145, 207144, 207143, 207119, 207118, 207117,
        207116, 207115, 207114, 207113, 207112, 207111, 207110, 207109, 207108, 207107, 207106,
        207105, 207104, 207103, 207102, 207101, 207100, 200569, 200568, 200567, 200566, 200565,
        198263, 198262, 197606, 197605, 197554, 197553, 197548, 197547, 197546, 197545, 197544,
        197543, 197542, 197541, 197540, 197539, 197538, 197537, 197536, 197535, 197534, 197533,
        197532, 197531, 197530, 197529, 197528, 197527, 197526, 197525, 197524, 197523, 197522,
        197521, 197520, 197519, 197518, 197517, 197516, 197515, 197514, 197513, 197512, 197511,
        197510, 197509, 197508, 197507, 197506, 197505, 197504, 197503, 197502, 197501, 197500,
        172482, 172480, 172479, 172478, 172477, 172476, 172427, 172426, 172425, 172424, 172423,
        172421, 172420, 172419, 172418, 172417, 172416, 172415, 172414, 172413, 172412, 172411,
        172410, 172409, 172408, 172407, 172406, 172405, 172404, 172403, 172402, 172401, 172400,
        172399, 172398, 172397, 172396, 172395, 172394, 172393, 172392, 172391, 172390, 172389,
        172388, 172387, 172386, 172385, 172384, 172383, 172382, 172381, 172380, 172379, 172378,
        172377, 172376, 172375, 172374, 172373, 172372, 172371, 172370, 172369, 172368, 172367,
        172366, 172365, 172364, 172363, 172362, 172361, 172360, 172359, 172358, 172357, 172356,
        172355, 172354, 172353, 172352, 172351, 172350, 172349, 172348, 172347, 172346, 172345,
        172344, 172343, 172342, 172341, 172340, 172339, 172338, 172337, 172336, 172335, 172334,
        172333, 233478, 233477, 233476, 233475, 233474, 233473, 233472, 233471, 213148, 213147,
        213146, 213145, 213144, 213143, 212752, 212751, 212750, 212749, 212748, 212638, 212637,
        212629, 212628, 212627, 212626, 212625, 212624, 212623, 212622, 212621, 212620, 212619,
        212618, 212617, 212616, 212615, 212614, 212613, 212612, 212611, 212610, 212609, 212608,
        212607, 212606, 212605, 212604, 212603, 212602, 212601, 212600, 212599, 212598, 212597,
        212596, 212595, 212594, 212593, 212592, 212591, 212590, 212589, 212588, 212587, 212586,
        212585, 212584, 212583, 212582, 212581, 212580, 212579, 212578, 212577, 212576, 212575,
        212574, 212573, 212572, 212571, 212570, 212569, 212568, 212567, 212566, 212565, 212564,
        212563, 212562, 212561, 212560, 212559, 212558, 212557, 212556, 212555, 212554, 212553,
        212552, 212551, 179641, 179640, 179639, 179638, 179637, 179636, 179635, 179634, 179633,
        179632, 179631, 179630, 179629, 179628, 179627, 179626, 179625, 179624, 179623, 179622,
        179621, 179620, 179619, 179618, 179617, 179616, 179615, 179614, 179613, 179612, 179611,
        179610, 179609, 179608, 179607, 179606, 179605, 179604, 179603, 179503, 178691, 175135,
        175101, 175100, 175099, 175098, 175097, 175096, 175095, 175094, 175093, 175092, 174196,
        174195, 174194, 174193, 174192, 174191, 174190, 174189, 174188, 174187, 174186, 174185,
        174184, 174183, 174182, 174181, 174180, 174179, 174178, 174177, 174176, 174175, 174174,
        174173, 174172, 174171, 174170, 174169, 174168, 174167, 174166, 174165, 174164, 174163,
        174162, 174161, 174160, 174159, 174158, 174157, 174156, 174155, 174154, 174153, 174152,
        174151, 174150, 174149, 190832, 190831, 190830, 190829, 190828, 190827, 190826, 190825,
        190824, 190823, 190822, 190821, 190820, 190819, 190818, 190817, 190816, 190815, 190814,
        190813, 190812, 190811, 190810, 190809, 190808, 190807, 190806, 190805, 190804, 190803,
        190802, 190801, 190800, 190799, 190798, 190797, 190796, 190795, 190794, 190793, 190792,
        190791, 190790, 190789, 190788, 190787, 190786, 190785, 190784, 190783, 190782, 190781,
        190780, 190779, 190747, 188233, 188232, 185603, 185602, 185601, 185600, 185598, 185597,
        185596, 185595, 185594, 185593, 185592, 185472, 182785, 182479, 182475, 182474, 180848,
        180844, 180841, 179865, 179864, 179863, 179862, 179861, 179860, 179859, 179858, 179857,
        179856, 179855, 179854, 179853, 179852, 179851, 179850, 179849, 179848, 179847, 179846,
        179845, 179844, 179843, 179842, 212550, 212549, 212548, 212547, 212546, 212545, 212544,
        212543, 212542, 212541, 212540, 212539, 212538, 212537, 212536, 212535, 212534, 212533,
        212532, 212531, 212530, 212529, 212528, 212527, 212526, 212525, 212524, 212523, 212522,
        212521, 212520, 212519, 212518, 212517, 212516, 212515, 212514, 212513, 212512, 212511,
        212510, 212509, 212508, 212507, 212506, 212505, 212504, 212503, 212502, 212501, 212500,
        212499, 212498, 212497, 212496, 212495, 212494, 212493, 212492, 212491, 212490, 212489,
        212488, 212487, 212486, 212485, 212484, 212483, 212482, 212481, 212480, 212479, 212478,
        212477, 212476, 212475, 212474, 212473, 212472, 212471, 212470, 212469, 212468, 212467,
        212466, 212465, 212464, 212463, 212462, 212461, 212460, 212459, 212458, 212457, 212456,
        212455, 212454, 212453, 212452, 208064, 174148, 174147, 174146, 174145, 174144, 174143,
        174142, 174141, 174140, 174139, 174138, 174137, 174136, 174135, 174134, 174133, 174132,
        174131, 174130, 174129, 174128, 174127, 174126, 174125, 174124, 174123, 174122, 174121,
        174120, 174119, 174118, 174117, 174116, 174115, 174114, 174113, 174112, 174111, 174110,
        174109, 174108, 174107, 174106, 174105, 174104, 174103, 174102, 174101, 174100, 174099,
        174098, 174097, 174096, 174095, 174094, 174093, 174092, 174091, 174090, 174089, 174088,
        174087, 174086, 174085, 174084, 174083, 174082, 174081, 174080, 174079, 174078, 174077,
        174076, 174075, 174074, 174073, 174072, 174071, 174017, 174015, 173488, 172509, 172508,
        172506, 172505, 172504, 172503, 172502, 172501, 172500, 172499, 172498, 172497, 172496,
        172490, 172489, 172487, 172485, 172484, 172483,
    ];
    // let intra_id = [
    //     "akkim", "bjeong", "bonikoo", "bonikoo", "byeolee", "bylim", "byoulee", "chakim",
    //     "changwpa", "dajikim", "djang", "dohyeki2", "dukim", "dukim", "eunam", "gihokim", "halee",
    //     "hisong", "hugim", "hyeyeom", "injo", "jaeholee", "jaehylee", "jaemyu", "jahwang",
    //     "jechoi", "jehbae", "jeonhan", "jinsekan", "jinseo", "jongckim", "joonchoi", "junjang",
    //     "minjkang", "sanghul2", "sanghul2", "seojikim", "seunbaek", "seungjuk", "soochoi", "ssohn",
    //     "taewonki", "takwak", "yeonjuki", "yoshin", "yuhyoon",
    // ]
    // .map(std::string::ToString::to_string);
    let client = Arc::new(FtClient::with_ratelimits(
        FtClientReqwestConnector::new(),
        8,
        1600,
    ));

    let mut result = Vec::new();
    for id in user_ids {
        let client = Arc::clone(&client);
        handles.spawn(async move {
            let token = FtApiToken::try_get(AuthInfo::build_from_env().unwrap())
                .await
                .unwrap();
            let session = client.open_session(token);
            loop {
                let result = session
                    .users_id(FtApiUsersIdRequest::new(FtUserIdentifier::UserId(
                        FtUserId::new(id),
                    )))
                    .await;
                match result {
                    Ok(v) => return v.user,
                    Err(FtClientError::RateLimitError(v)) => {
                        sleep(v.retry_after.unwrap()).await;
                    }
                    Err(e) => {
                        tracing::error!("{:?}", e)
                    }
                }
            }
        });
    }

    while let Some(Ok(v)) = handles.join_next().await {
        result.push(v);
    }

    let mut file = std::fs::File::create("cadet.json").unwrap();
    file.write_all(serde_json::to_string_pretty(&result).unwrap().as_bytes())
        .unwrap();
}
